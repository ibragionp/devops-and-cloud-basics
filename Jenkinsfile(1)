pipeline {

    agent any
  
    environment {
    AWS_ACCESS_KEY_ID     = credentials('jenkins-aws-secret-key-id')
    AWS_SECRET_ACCESS_KEY = credentials('jenkins-aws-secret-access-key')
    }

    stages {
         
        stage('Prepare enviroment') {
               
            steps {
                sh'''
                sudo yum update -y
                sudo amazon-linux-extras install docker
                sudo yum install docker
                sudo service docker start
                sudo usermod -a -G docker ec2-user
                '''
                
                sh'''
                sudo chmod 777 /var/run/docker.sock
                '''
               
            }
        }


        stage('Build') {

            steps {
                
               sh '''
                docker build -t testing .
                '''
               
               sh '''
                docker run testing main.py
                '''

            }

        }
        
        stage('Test') {

            steps {
                
               sh '''
                docker run -it testing main_test.py

                '''

            }

        }




    }

}
